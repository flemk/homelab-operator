{% extends 'html/base.html' %}

{% if homelab %}
    {% block title %}
        {{ homelab.name }} - Auto Discover in progress
    {% endblock %}
{% endif %}

{% block content %}
    <div>
        <span style="display: flex;">
            <h2 style="margin-bottom: .25rem;">Auto Discovery in progress</h2>
        </span>
        <div class="soft">
            Please be patient. The auto discovery process is currently running.
        </div>
        <div class="soft">
            Subnetwork: <strong>{{ network.subnet }}</strong>
        </div>
        <div class="soft">
            Task ID: <strong>{{ task_id }}</strong>
        </div>
    </div>
    <div id="enable-scroll-btn" class="soft info button inline-button" style="margin-top: 1rem; width: min-content;">Disable Auto-Scroll</div>
    <div style="border: 1px solid var(--border-color); border-radius: 1rem; margin-top: .25rem; background-color: var(--header-background-color);">
        <iframe id="auto-discover-iframe" src="{% url 'auto_discover_stream' network_id=network.id task_id=task_id %}" style="width: 100%; height: 500px; border: none;">
            Your browser does not support iframes. Please activate javascript or use a different browser.
        </iframe>
    </div>
    <div class="soft" style="text-align: center; margin-top: .25rem;">
        You will be redirected to the results page once the discovery is complete.
    </div>
    <script>
        // Redirect to results page when the iframe content is fully loaded
        const iframe_ = document.getElementById('auto-discover-iframe');
        function checkIframeStatus() {
            try {
                if (iframe_.contentDocument && iframe_.contentDocument.readyState === 'complete') {
                    if (iframe_.contentDocument.body && iframe_.contentDocument.body.innerText.includes('Discovery complete.')) {
                        window.location.href = "{% url 'auto_discover_results' network_id=network.id task_id=task_id %}";
                    }
                }
            } catch (e) {
                // Cross-origin, cannot access
            }
        }
        setInterval(checkIframeStatus, 2000);
    </script>
    <script>
        // Auto-scroll functionality for the iframe
        const iframe = document.getElementById('auto-discover-iframe');
        const enableScrollBtn = document.getElementById('enable-scroll-btn');
        let autoScrollEnabled = true;

        enableScrollBtn.addEventListener('click', function() {
            autoScrollEnabled = !autoScrollEnabled;
            enableScrollBtn.textContent = autoScrollEnabled ? 'Disable Auto-Scroll' : 'Enable Auto-Scroll';
            enableScrollBtn.classList.toggle('active', autoScrollEnabled);
        });

        function scrollIframeToBottom() {
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                doc.documentElement.scrollTop = doc.documentElement.scrollHeight;
                doc.body.scrollTop = doc.body.scrollHeight;
            } catch (e) {}
        }

        iframe.onload = function() {
            if (autoScrollEnabled) {
                scrollIframeToBottom();
            }
        };

        setInterval(function() {
            if (autoScrollEnabled) {
                scrollIframeToBottom();
            }
        }, 1000);
    </script>
{% endblock %}
