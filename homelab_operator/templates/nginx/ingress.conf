# Auto-generated ingress configuration
# Generated at {{ now }}

server {
    listen 80;
    listen 443 ssl;
    server_name {{ hostname }};

    ssl_certificate ./crt/cert.crt;
    ssl_certificate_key ./crt/key.key;

    {% for ingress in ingresses %}
    location {{ ingress.path_prefix }} {
        # Rule: {{ ingress.name }} (Priority: {{ ingress.priority }})

        {% if rule.forward_type == 'REDIRECT' %}
        return 301 {{ ingress.get_target_url }}$request_uri;
        {% else %}

        # Proxy configuration
        proxy_pass {{ ingress.get_target_url }};

        {% if ingress.preserve_host %}
        proxy_set_header Host $host;
        {% else %}
        proxy_set_header Host {{ ingress.target_service.endpoint|default:ingress.target_service.server.ip_address }};
        {% endif %}

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Logging for statistics
        access_log /var/log/nginx/ingress_{{ ingress.id }}.log;

        # Optional: Strip path prefix
        {% if ingress.strip_path_prefix and ingress.path_prefix != '/' %}
        rewrite ^{{ ingress.path_prefix }}(.*)$ /$1 break;
        {% endif %}
        {% endif %}
    }
    {% endfor %}
}
