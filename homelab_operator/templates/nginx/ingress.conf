# Auto-generated ingress configuration
# Generated at {{ now }}

{% for hostname, rules in hostname_rules.items %}
server {
    listen 80;
    listen 443 ssl;
    server_name {{ hostname }};
    
    ssl_certificate ./crt/cert.crt;
    ssl_certificate_key ./crt/key.key;
    
    {% for rule in rules %}
    location {{ rule.path_prefix }} {
        # Rule: {{ rule.name }} (Priority: {{ rule.priority }})
        
        {% if rule.forward_type == 'REDIRECT' %}
        return 301 {{ rule.get_target_url }}$request_uri;
        {% else %}
        # Proxy configuration
        proxy_pass {{ rule.get_target_url }};
        
        {% if rule.preserve_host %}
        proxy_set_header Host $host;
        {% else %}
        proxy_set_header Host {{ rule.target_service.endpoint|default:rule.target_service.server.ip_address }};
        {% endif %}
        
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Logging for statistics
        access_log /var/log/nginx/ingress_{{ rule.id }}.log;
        
        # Optional: Strip path prefix
        {% if rule.strip_path_prefix and rule.path_prefix != '/' %}
        rewrite ^{{ rule.path_prefix }}(.*)$ /$1 break;
        {% endif %}
        {% endif %}
    }
    {% endfor %}
}
{% endfor %}
